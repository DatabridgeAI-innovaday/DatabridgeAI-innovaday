// ==================== HARDCODED CREDENTIALS ====================
const USERS = {
    'admin@daycoval.com': {
        password: 'admin123',
        name: 'Administrador',
        profiles: ['user', 'developer'],
        level: 10,
        tokens: 25430,
        savedMessages: 45
    },
    'user@daycoval.com': {
        password: 'user123',
        name: 'Usu√°rio Comum',
        profiles: ['user'],
        level: 5,
        tokens: 12450,
        savedMessages: 28
    },
    'dev@daycoval.com': {
        password: 'dev123',
        name: 'Maria Santos',
        profiles: ['developer'],
        level: 8,
        tokens: 18920,
        savedMessages: 67
    }
};

// ==================== STATE ====================
let currentUser = null;
let currentProfile = null;
let chatMessages = [];
let isTyping = false;
let suggestionsAdded = false;
let lastUserQuestion = ''; // Armazena a √∫ltima pergunta do usu√°rio
let lastResponseType = 'text'; // Armazena o tipo da √∫ltima resposta (text, report, sql)

// ==================== DOM ELEMENTS ====================
const elements = {
    // FAB
    fabButton: document.getElementById('fabButton'),
    
    // Login
    loginOverlay: document.getElementById('loginOverlay'),
    loginModal: document.getElementById('loginModal'),
    loginForm: document.getElementById('loginForm'),
    loginBtn: document.getElementById('loginBtn'),
    closeLogin: document.getElementById('closeLogin'),
    emailInput: document.getElementById('email'),
    passwordInput: document.getElementById('password'),
    
    // Profile Selection
    profileSelection: document.getElementById('profileSelection'),
    closeProfileSelection: document.getElementById('closeProfileSelection'),
    
    // Chat
    chatContainer: document.getElementById('chatContainer'),
    chatMessages: document.getElementById('chatMessages'),
    chatInput: document.getElementById('chatInput'),
    sendBtn: document.getElementById('sendBtn'),
    minimizeChat: document.getElementById('minimizeChat'),
    closeChat: document.getElementById('closeChat'),
    
    // Profile Panel
    profilePanel: document.getElementById('profilePanel'),
    closeProfilePanel: document.getElementById('closeProfilePanel'),
    profileName: document.getElementById('profileName'),
    profileType: document.getElementById('profileType'),
    profileLevel: document.getElementById('profileLevel'),
    profileTokens: document.getElementById('profileTokens'),
    profileMessages: document.getElementById('profileMessages'),
    viewLibraryBtn: document.getElementById('viewLibraryBtn'),
    logoutBtn: document.getElementById('logoutBtn'),
    
    // Library
    libraryContainer: document.getElementById('libraryContainer'),
    closeLibrary: document.getElementById('closeLibrary'),
    searchLibrary: document.getElementById('searchLibrary'),
    filterFolder: document.getElementById('filterFolder'),
    libraryContent: document.getElementById('libraryContent'),
    clearLibraryBtn: document.getElementById('clearLibraryBtn'),
    
    // Report
    reportContainer: document.getElementById('reportContainer'),
    closeReport: document.getElementById('closeReport'),
    reportTableBody: document.getElementById('reportTableBody'),
    totalPropostas: document.getElementById('totalPropostas'),
    valorTotal: document.getElementById('valorTotal'),
    valorMedio: document.getElementById('valorMedio'),
    reportDateTime: document.getElementById('reportDateTime'),
    reportRowCount: document.getElementById('reportRowCount'),
    
    // SQL Modal
    sqlModal: document.getElementById('sqlModal'),
    closeSqlModal: document.getElementById('closeSqlModal'),
    copySqlBtn: document.getElementById('copySqlBtn'),
    executeSqlBtn: document.getElementById('executeSqlBtn'),
    explainTablesBtn: document.getElementById('explainTablesBtn'),
    sqlCode: document.getElementById('sqlCode'),
    
    // Table Explanation Mini-Modal
    tableExplainModal: document.getElementById('tableExplainModal'),
    closeTableExplain: document.getElementById('closeTableExplain'),
    
    // Toast
    toast: document.getElementById('toast')
};

// ==================== EVENT LISTENERS ====================

// FAB Click
elements.fabButton.addEventListener('click', () => {
    if (currentUser && currentProfile) {
        showChat();
    } else if (currentUser) {
        showProfileSelection();
    } else {
        showLogin();
    }
});

// Close Login
elements.closeLogin.addEventListener('click', hideLogin);
elements.loginOverlay.addEventListener('click', (e) => {
    // Fechar a modal apropriada baseado no que est√° vis√≠vel
    if (elements.sqlModal.style.display === 'flex') {
        hideSqlModal();
    } else if (elements.reportContainer.style.display === 'flex') {
        hideReport();
    } else if (elements.libraryContainer.style.display === 'flex') {
        hideLibrary();
    } else if (elements.loginModal.style.display === 'block') {
        hideLogin();
    } else if (elements.profileSelection.style.display === 'block') {
        hideProfileSelection();
    }
});

// Login Form Submit
elements.loginForm.addEventListener('submit', handleLogin);

// Profile Selection
elements.closeProfileSelection.addEventListener('click', hideProfileSelection);
document.querySelectorAll('.profile-card').forEach(card => {
    card.addEventListener('click', function() {
        const profile = this.dataset.profile;
        selectProfile(profile);
    });
});

// Chat Input
elements.chatInput.addEventListener('input', (e) => {
    elements.sendBtn.disabled = e.target.value.trim() === '';
});

elements.chatInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        if (elements.chatInput.value.trim()) {
            sendMessage();
        }
    }
});

elements.sendBtn.addEventListener('click', sendMessage);

// Chat Actions
elements.openProfileBtn = document.getElementById('openProfileBtn');
elements.openProfileBtn.addEventListener('click', () => {
    if (elements.profilePanel.style.display === 'block') {
        hideProfilePanel();
    } else {
        showProfilePanel();
    }
});

elements.minimizeChat.addEventListener('click', hideChat);
elements.closeChat.addEventListener('click', () => {
    hideChat();
    logout();
});

// Profile Panel
elements.closeProfilePanel.addEventListener('click', hideProfilePanel);
elements.viewLibraryBtn.addEventListener('click', () => {
    hideProfilePanel();
    showLibrary();
});
elements.logoutBtn.addEventListener('click', logout);

// Library
elements.closeLibrary.addEventListener('click', hideLibrary);
if (elements.clearLibraryBtn) {
    elements.clearLibraryBtn.addEventListener('click', clearLibrary);
}

// Search Library
elements.searchLibrary.addEventListener('input', filterLibrary);
elements.filterFolder.addEventListener('change', filterLibrary);

// Report
if (elements.closeReport) {
    elements.closeReport.addEventListener('click', hideReport);
    console.log('‚úÖ Event listener para closeReport adicionado');
} else {
    console.error('‚ùå Elemento closeReport n√£o encontrado');
}

// SQL Modal
if (elements.closeSqlModal) {
    elements.closeSqlModal.addEventListener('click', hideSqlModal);
}
if (elements.copySqlBtn) {
    elements.copySqlBtn.addEventListener('click', copySqlQuery);
}
if (elements.executeSqlBtn) {
    elements.executeSqlBtn.addEventListener('click', () => {
        showToast('Fun√ß√£o de execu√ß√£o em desenvolvimento', 'info');
    });
}
if (elements.explainTablesBtn) {
    elements.explainTablesBtn.addEventListener('click', showTableExplanation);
}

// Table Explanation Mini-Modal
if (elements.closeTableExplain) {
    elements.closeTableExplain.addEventListener('click', hideTableExplanation);
}

// ==================== LOGIN FUNCTIONS ====================

function showLogin() {
    elements.loginOverlay.style.display = 'block';
    elements.loginModal.style.display = 'block';
}

function hideLogin() {
    elements.loginOverlay.style.display = 'none';
    elements.loginModal.style.display = 'none';
}

function handleLogin(e) {
    e.preventDefault();
    
    const email = elements.emailInput.value.trim();
    const password = elements.passwordInput.value;
    
    // Disable button and show loading
    elements.loginBtn.disabled = true;
    elements.loginBtn.textContent = 'Autenticando...';
    
    // Simulate API call
    setTimeout(() => {
        const user = USERS[email];
        
        if (!user || user.password !== password) {
            showToast('Usu√°rio ou senha incorretos', 'error');
            elements.loginBtn.disabled = false;
            elements.loginBtn.textContent = 'Entrar';
            return;
        }
        
        // Login successful
        currentUser = { email, ...user };
        
        hideLogin();
        elements.loginForm.reset();
        elements.loginBtn.disabled = false;
        elements.loginBtn.textContent = 'Entrar';
        
        showToast(`Bem-vindo, ${user.name}!`, 'success');
        
        // Show profile selection
        setTimeout(() => {
            showProfileSelection();
        }, 500);
        
    }, 1000);
}

// ==================== PROFILE SELECTION ====================

function showProfileSelection() {
    elements.loginOverlay.style.display = 'block';
    elements.profileSelection.style.display = 'block';
}

function hideProfileSelection() {
    elements.loginOverlay.style.display = 'none';
    elements.profileSelection.style.display = 'none';
}

function selectProfile(profile) {
    currentProfile = profile;
    
    hideProfileSelection();
    
    // Update profile panel
    elements.profileName.textContent = currentUser.name;
    elements.profileType.textContent = profile === 'developer' ? 'Desenvolvedor' : 'Usu√°rio';
    elements.profileLevel.textContent = currentUser.level;
    elements.profileTokens.textContent = currentUser.tokens.toLocaleString('pt-BR');
    
    // Atualizar contador de mensagens baseado nas mensagens reais do usu√°rio
    const userMessages = getUserMessages();
    currentUser.savedMessages = userMessages.length;
    elements.profileMessages.textContent = userMessages.length;
    
    showToast('Perfil selecionado!', 'success');
    
    // Show chat only (profile panel opens on button click)
    setTimeout(() => {
        showChat();
        
        // Add suggestions message if not already added
        if (!suggestionsAdded) {
            setTimeout(() => {
                addSuggestionsMessage();
                suggestionsAdded = true;
            }, 300);
        }
    }, 500);
}

// ==================== PROFILE PANEL ====================

function showProfilePanel() {
    elements.profilePanel.style.display = 'block';
}

function hideProfilePanel() {
    elements.profilePanel.style.display = 'none';
}

// ==================== CHAT FUNCTIONS ====================

function showChat() {
    elements.chatContainer.style.display = 'flex';
    elements.chatInput.focus();
}

function hideChat() {
    elements.chatContainer.style.display = 'none';
}

function sendMessage() {
    const text = elements.chatInput.value.trim();
    if (!text || isTyping) return;
    
    // Armazenar a pergunta do usu√°rio
    lastUserQuestion = text;
    
    // Add user message
    addMessage(text, 'user');
    
    // Clear input
    elements.chatInput.value = '';
    elements.sendBtn.disabled = true;
    
    // Simulate bot response
    simulateBotResponse(text);
}

function addMessage(text, sender = 'bot') {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}-message`;
    
    const avatar = document.createElement('div');
    avatar.className = 'message-avatar';
    avatar.innerHTML = sender === 'bot' ? '<i class="fas fa-robot"></i>' : '<i class="fas fa-user"></i>';
    
    const content = document.createElement('div');
    content.className = 'message-content';
    
    const messageText = document.createElement('div');
    messageText.className = 'message-text';
    messageText.textContent = text;
    
    const time = document.createElement('div');
    time.className = 'message-time';
    time.textContent = formatTime(new Date());
    
    content.appendChild(messageText);
    content.appendChild(time);
    
    // Add action buttons for bot messages
    if (sender === 'bot') {
        const actions = document.createElement('div');
        actions.className = 'message-actions';
        actions.innerHTML = `
            <button class="action-btn" onclick="saveMessage(\`${lastUserQuestion.replace(/`/g, '\\`')}\`, \`${text.replace(/`/g, '\\`')}\`, '${lastResponseType}')">
                <i class="fas fa-save"></i> Salvar
            </button>
            <button class="action-btn" onclick="copyMessage(\`${text.replace(/`/g, '\\`')}\`)">
                <i class="fas fa-copy"></i> Copiar
            </button>
        `;
        content.appendChild(actions);
    }
    
    messageDiv.appendChild(avatar);
    messageDiv.appendChild(content);
    
    elements.chatMessages.appendChild(messageDiv);
    elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
    
    // Save to history
    chatMessages.push({ text, sender, time: new Date() });
}

function addSuggestionsMessage() {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message bot-message suggestions-message';
    
    const avatar = document.createElement('div');
    avatar.className = 'message-avatar';
    avatar.innerHTML = '<i class="fas fa-robot"></i>';
    
    const content = document.createElement('div');
    content.className = 'message-content';
    
    const messageText = document.createElement('div');
    messageText.className = 'message-text';
    
    // Verificar os perfis do usu√°rio logado (n√£o o perfil selecionado)
    const userProfiles = currentUser ? currentUser.profiles : [];
    const hasUserProfile = userProfiles.includes('user');
    const hasDeveloperProfile = userProfiles.includes('developer');
    
    let suggestionsHTML = `
        <div style="margin-bottom: 0.75rem; color: #666; font-size: 0.9rem;">
            <i class="fas fa-lightbulb"></i> Sugest√µes r√°pidas:
        </div>
        <div class="quick-suggestions">
    `;
    
    // Sugest√µes para usu√°rios com perfil USER
    if (hasUserProfile) {
        suggestionsHTML += `
            <button class="suggestion-btn" onclick="useSuggestion('Quantos cart√µes est√£o com status de extravio?')">
                Quantos cart√µes est√£o com status de extravio?
            </button>
            <button class="suggestion-btn" onclick="useSuggestion('Qual empregador tem a maior carteira?')">
                Qual empregador tem a maior carteira?
            </button>
            <button class="suggestion-btn" onclick="useSuggestion('Relat√≥rio da Esteira de Cr√©dito (30 dias)')">
                Relat√≥rio da Esteira de Cr√©dito (30 dias)
            </button>
        `;
    }
    
    // Sugest√£o exclusiva para usu√°rios com perfil DEVELOPER
    if (hasDeveloperProfile) {
        suggestionsHTML += `
            <button class="suggestion-btn" onclick="useSuggestion('Gerar uma query para novos cart√µes de INSS desde novembro desse ano')">
                Gerar uma query para novos cart√µes de INSS desde novembro desse ano
            </button>
        `;
    }
    
    suggestionsHTML += `</div>`;
    
    messageText.innerHTML = suggestionsHTML;
    
    const time = document.createElement('div');
    time.className = 'message-time';
    time.textContent = formatTime(new Date());
    
    content.appendChild(messageText);
    content.appendChild(time);
    
    messageDiv.appendChild(avatar);
    messageDiv.appendChild(content);
    
    elements.chatMessages.appendChild(messageDiv);
    elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
}

function useSuggestion(text) {
    elements.chatInput.value = text;
    elements.sendBtn.disabled = false;
    elements.chatInput.focus();
    // Opcional: enviar automaticamente
    // sendMessage();
}

function simulateBotResponse(userMessage) {
    isTyping = true;
    
    // Show thinking animation
    const thinkingDiv = document.createElement('div');
    thinkingDiv.className = 'message bot-message';
    thinkingDiv.innerHTML = `
        <div class="message-avatar">
            <i class="fas fa-robot"></i>
        </div>
        <div class="message-content">
            <div class="message-text thinking-animation">
                <div class="thinking-dot"></div>
                <div class="thinking-dot"></div>
                <div class="thinking-dot"></div>
            </div>
        </div>
    `;
    elements.chatMessages.appendChild(thinkingDiv);
    elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
    
    // Simulate thinking time (2-3 seconds)
    setTimeout(() => {
        thinkingDiv.remove();
        
        // Generate response based on user message
        const response = generateResponse(userMessage);
        
        // Type out response
        typeMessage(response);
        
    }, 2000 + Math.random() * 1000);
}

function typeMessage(text) {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message bot-message';
    
    const avatar = document.createElement('div');
    avatar.className = 'message-avatar';
    avatar.innerHTML = '<i class="fas fa-robot"></i>';
    
    const content = document.createElement('div');
    content.className = 'message-content';
    
    const messageText = document.createElement('div');
    messageText.className = 'message-text';
    
    const time = document.createElement('div');
    time.className = 'message-time';
    time.textContent = formatTime(new Date());
    
    content.appendChild(messageText);
    content.appendChild(time);
    
    messageDiv.appendChild(avatar);
    messageDiv.appendChild(content);
    
    elements.chatMessages.appendChild(messageDiv);
    
    // Type effect
    let index = 0;
    const typeInterval = setInterval(() => {
        if (index < text.length) {
            messageText.textContent += text[index];
            index++;
            elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
        } else {
            clearInterval(typeInterval);
            
            // Add action buttons
            const actions = document.createElement('div');
            actions.className = 'message-actions';
            actions.innerHTML = `
                <button class="action-btn" onclick="saveMessage(\`${lastUserQuestion.replace(/`/g, '\\`')}\`, \`${text.replace(/`/g, '\\`')}\`, '${lastResponseType}')">
                    <i class="fas fa-save"></i> Salvar
                </button>
                <button class="action-btn" onclick="copyMessage(\`${text.replace(/`/g, '\\`')}\`)">
                    <i class="fas fa-copy"></i> Copiar
                </button>
            `;
            content.appendChild(actions);
            
            isTyping = false;
            chatMessages.push({ text, sender: 'bot', time: new Date() });
        }
    }, 30);
}

function generateResponse(userMessage) {
    const lowerMessage = userMessage.toLowerCase();
    
    // Obter data e hora atual formatadas
    const agora = new Date();
    const dataFormatada = agora.toLocaleDateString('pt-BR', { 
        day: '2-digit', 
        month: 'long', 
        year: 'numeric' 
    });
    const horaFormatada = agora.toLocaleTimeString('pt-BR', { 
        hour: '2-digit', 
        minute: '2-digit' 
    });
    
    // Extravio
    if (lowerMessage.includes('extravio') || lowerMessage.includes('extraviado')) {
        lastResponseType = 'text';
        return `Na data de hoje, ${dataFormatada} √†s ${horaFormatada}, temos 435 cart√µes com status de extravio.`;
    }
    
    // Empregador com maior carteira
    if (lowerMessage.includes('empregador') || lowerMessage.includes('maior carteira')) {
        lastResponseType = 'text';
        return `Na data de hoje, ${dataFormatada} √†s ${horaFormatada}, o INSS √© a maior carteira com 310 mil cart√µes ativos, totalizando um valor de R$ 933.857.569,00`;
    }
    
    // Query SQL para novos cart√µes INSS (Apenas para Desenvolvedores)
    if ((lowerMessage.includes('gerar') || lowerMessage.includes('query')) && lowerMessage.includes('inss') && lowerMessage.includes('novembro')) {
        if (currentProfile === 'developer') {
            lastResponseType = 'sql';
            setTimeout(() => {
                showSqlModal();
            }, 100);
            return `Gerando query SQL para novos cart√µes de INSS desde novembro de 2025... Exibindo resultado.`;
        } else {
            lastResponseType = 'text';
            return `Desculpe, essa funcionalidade est√° dispon√≠vel apenas para desenvolvedores.`;
        }
    }
    
    // Relat√≥rio de propostas
    if (lowerMessage.includes('relat√≥rio') || lowerMessage.includes('relatorio') || lowerMessage.includes('esteira') || lowerMessage.includes('propostas')) {
        lastResponseType = 'report';
        // Exibir relat√≥rio em modal
        setTimeout(() => {
            showReport();
        }, 100);
        return `Gerando relat√≥rio das propostas dos √∫ltimos 30 dias na esteira de cr√©dito... Um momento, por favor.`;
    }
    
    // Default response
    lastResponseType = 'text';
    return 'Entendo sua solicita√ß√£o. Estou aqui para ajudar! Como posso auxiliar voc√™?';
}

// ==================== MESSAGE ACTIONS ====================

window.saveMessage = function(question, answer, responseType) {
    // Se foi chamado com apenas um par√¢metro (compatibilidade com c√≥digo antigo)
    if (answer === undefined) {
        answer = '';
        question = question || '';
    }
    
    // Tipo padr√£o √© 'text'
    responseType = responseType || 'text';
    
    showToast('Pergunta salva na biblioteca!', 'success');
    
    // Save to localStorage
    const savedMessages = JSON.parse(localStorage.getItem('dcc_saved_messages') || '[]');
    savedMessages.push({
        id: Date.now(),
        text: question, // Salva a PERGUNTA
        answer: answer, // Armazena a resposta para refer√™ncia futura
        responseType: responseType, // Tipo: 'text', 'report', 'sql'
        folder: 'Geral',
        userEmail: currentUser.email, // Email do usu√°rio que salvou
        savedAt: new Date().toISOString()
    });
    localStorage.setItem('dcc_saved_messages', JSON.stringify(savedMessages));
    
    // Update count (apenas mensagens do usu√°rio atual)
    const userMessages = getUserMessages();
    currentUser.savedMessages = userMessages.length;
    elements.profileMessages.textContent = userMessages.length;
};

window.copyMessage = function(text) {
    navigator.clipboard.writeText(text).then(() => {
        showToast('Mensagem copiada!', 'success');
    }).catch(() => {
        showToast('Erro ao copiar mensagem', 'error');
    });
};

// ==================== LIBRARY ====================

function getUserMessages() {
    const allMessages = JSON.parse(localStorage.getItem('dcc_saved_messages') || '[]');
    
    // Se for admin, retorna todas as mensagens
    if (currentUser && currentUser.email === 'admin@daycoval.com') {
        return allMessages;
    }
    
    // Caso contr√°rio, retorna apenas as mensagens do usu√°rio atual
    return allMessages.filter(msg => msg.userEmail === (currentUser ? currentUser.email : ''));
}

function showLibrary() {
    elements.libraryContainer.style.display = 'flex';
    elements.loginOverlay.style.display = 'block';
    loadLibrary();
}

function hideLibrary() {
    elements.libraryContainer.style.display = 'none';
    elements.loginOverlay.style.display = 'none';
}

function loadLibrary() {
    const savedMessages = getUserMessages();
    
    if (savedMessages.length === 0) {
        elements.libraryContent.innerHTML = `
            <div class="empty-library">
                <i class="fas fa-folder-open"></i>
                <p>Nenhuma mensagem salva ainda</p>
                <small>Salve mensagens do chat para v√™-las aqui</small>
            </div>
        `;
        return;
    }
    
    // Group by folder
    const byFolder = {};
    savedMessages.forEach(msg => {
        if (!byFolder[msg.folder]) {
            byFolder[msg.folder] = [];
        }
        byFolder[msg.folder].push(msg);
    });
    
    let html = '';
    Object.keys(byFolder).forEach(folder => {
        html += `
            <div class="library-folder">
                <h4><i class="fas fa-folder"></i> ${folder} (${byFolder[folder].length})</h4>
                <div class="library-items">
                    ${byFolder[folder].map(msg => `
                        <div class="library-item">
                            <div class="library-item-content" onclick="reopenMessage(${msg.id})" style="cursor: pointer;" title="Clique para ver a resposta">
                                <div class="library-item-text">${truncateText(msg.text, 150)}</div>
                                <div class="library-item-date">
                                    <i class="fas fa-clock"></i> ${formatDate(new Date(msg.savedAt))}
                                </div>
                            </div>
                            <button class="library-item-delete" onclick="event.stopPropagation(); deleteLibraryItem(${msg.id})" title="Excluir">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    });
    
    elements.libraryContent.innerHTML = html;
}

function filterLibrary() {
    const search = elements.searchLibrary.value.toLowerCase();
    const folder = elements.filterFolder.value;
    
    const savedMessages = getUserMessages();
    let filtered = savedMessages;
    
    if (search) {
        filtered = filtered.filter(msg => msg.text.toLowerCase().includes(search));
    }
    
    if (folder) {
        filtered = filtered.filter(msg => msg.folder === folder);
    }
    
    // Re-render
    if (filtered.length === 0) {
        elements.libraryContent.innerHTML = `
            <div class="empty-library">
                <i class="fas fa-search"></i>
                <p>Nenhuma mensagem encontrada</p>
                <small>Tente ajustar os filtros</small>
            </div>
        `;
        return;
    }
    
    const byFolder = {};
    filtered.forEach(msg => {
        if (!byFolder[msg.folder]) {
            byFolder[msg.folder] = [];
        }
        byFolder[msg.folder].push(msg);
    });
    
    let html = '';
    Object.keys(byFolder).forEach(folder => {
        html += `
            <div class="library-folder">
                <h4><i class="fas fa-folder"></i> ${folder} (${byFolder[folder].length})</h4>
                <div class="library-items">
                    ${byFolder[folder].map(msg => `
                        <div class="library-item">
                            <div class="library-item-content" onclick="reopenMessage(${msg.id})" style="cursor: pointer;" title="Clique para ver a resposta">
                                <div class="library-item-text">${truncateText(msg.text, 150)}</div>
                                <div class="library-item-date">
                                    <i class="fas fa-clock"></i> ${formatDate(new Date(msg.savedAt))}
                                </div>
                            </div>
                            <button class="library-item-delete" onclick="event.stopPropagation(); deleteLibraryItem(${msg.id})" title="Excluir">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    });
    
    elements.libraryContent.innerHTML = html;
}

function clearLibrary() {
    if (confirm('‚ö†Ô∏è Tem certeza que deseja limpar toda a biblioteca?\n\nEsta a√ß√£o n√£o pode ser desfeita!')) {
        const userMessages = getUserMessages();
        const count = userMessages.length;
        
        if (count === 0) {
            showToast('A biblioteca j√° est√° vazia', 'info');
            return;
        }
        
        const allMessages = JSON.parse(localStorage.getItem('dcc_saved_messages') || '[]');
        
        // Se for admin, limpa tudo
        if (currentUser && currentUser.email === 'admin@daycoval.com') {
            localStorage.removeItem('dcc_saved_messages');
        } else {
            // Caso contr√°rio, mant√©m apenas as mensagens de outros usu√°rios
            const otherUsersMessages = allMessages.filter(msg => msg.userEmail !== currentUser.email);
            localStorage.setItem('dcc_saved_messages', JSON.stringify(otherUsersMessages));
        }
        
        // Update user count
        if (currentUser) {
            currentUser.savedMessages = 0;
            elements.profileMessages.textContent = '0';
        }
        
        showToast(`${count} ${count === 1 ? 'mensagem removida' : 'mensagens removidas'} com sucesso!`, 'success');
        loadLibrary();
    }
}

window.deleteLibraryItem = function(itemId) {
    if (confirm('Deseja realmente excluir esta mensagem?')) {
        let savedMessages = JSON.parse(localStorage.getItem('dcc_saved_messages') || '[]');
        savedMessages = savedMessages.filter(msg => msg.id !== itemId);
        
        localStorage.setItem('dcc_saved_messages', JSON.stringify(savedMessages));
        
        // Update user count (apenas mensagens do usu√°rio atual)
        if (currentUser) {
            const userMessages = getUserMessages();
            currentUser.savedMessages = userMessages.length;
            elements.profileMessages.textContent = userMessages.length;
        }
        
        showToast('Mensagem exclu√≠da com sucesso!', 'success');
        
        // Recarregar biblioteca ou filtro
        if (elements.searchLibrary.value || elements.filterFolder.value) {
            filterLibrary();
        } else {
            loadLibrary();
        }
    }
};

window.reopenMessage = function(itemId) {
    // Buscar a mensagem salva
    const savedMessages = JSON.parse(localStorage.getItem('dcc_saved_messages') || '[]');
    const message = savedMessages.find(msg => msg.id === itemId);
    
    if (!message) {
        showToast('Mensagem n√£o encontrada', 'error');
        return;
    }
    
    // Fechar biblioteca
    hideLibrary();
    
    // Verificar o tipo de resposta
    const responseType = message.responseType || 'text';
    
    // Se for modal, abrir a modal apropriada
    if (responseType === 'report') {
        showToast('Abrindo relat√≥rio...', 'info');
        setTimeout(() => {
            showReport();
        }, 300);
        return;
    }
    
    if (responseType === 'sql') {
        showToast('Abrindo query SQL...', 'info');
        setTimeout(() => {
            showSqlModal();
        }, 300);
        return;
    }
    
    // Se for texto normal, mostrar no chat
    // Garantir que o chat est√° vis√≠vel
    showChat();
    
    // Adicionar a pergunta como mensagem do usu√°rio
    addMessage(message.text, 'user');
    
    // Adicionar a resposta como mensagem do bot (se existir)
    if (message.answer) {
        setTimeout(() => {
            addMessage(message.answer, 'bot');
            showToast('Conversa restaurada da biblioteca', 'info');
        }, 300);
    } else {
        showToast('Pergunta adicionada ao chat', 'info');
    }
};

// ==================== REPORT ====================

function showReport() {
    elements.reportContainer.style.display = 'flex';
    elements.loginOverlay.style.display = 'block';
    generateReport();
}

function hideReport() {
    elements.reportContainer.style.display = 'none';
    elements.loginOverlay.style.display = 'none';
}

function generateReport() {
    // Esteiras de cr√©dito
    const esteiras = [
        { nome: 'RMC', tipo: 'inicio' },
        { nome: 'Consist√™ncia de Dados', tipo: 'validacao' },
        { nome: 'Confer√™ncia de documentos', tipo: 'validacao' },
        { nome: 'Atribui√ß√£o de Limite', tipo: 'analise' },
        { nome: 'An√°lise P√≥s Venda', tipo: 'analise' },
        { nome: 'Pend√™ncia', tipo: 'aguardando' },
        { nome: 'Cancelada', tipo: 'final' },
        { nome: 'Recusada', tipo: 'final' },
        { nome: 'Limite(Al√ßada)', tipo: 'analise' },
        { nome: 'An√°lise Pr√© Saque', tipo: 'analise' },
        { nome: 'Aguardando Envio da Emiss√£o do Cart√£o', tipo: 'aguardando' },
        { nome: 'Aguardando emiss√£o do cart√£o', tipo: 'aguardando' },
        { nome: 'Cart√£o emitido', tipo: 'final' }
    ];
    
    let totalGeral = 0;
    let valorTotalGeral = 0;
    let html = '';
    
    esteiras.forEach(esteira => {
        // Quantidade aleat√≥ria entre 10 e 5000
        const quantidade = Math.floor(Math.random() * 4990) + 10;
        
        // Valor m√©dio entre R$ 500 e R$ 5000
        const valorMedio = Math.floor(Math.random() * 4500) + 500;
        const valorTotalEsteira = quantidade * valorMedio;
        
        // Tempo m√©dio em dias (1 a 15 dias)
        const tempoMedio = Math.floor(Math.random() * 15) + 1;
        
        // Determinar status baseado na quantidade
        let statusClass = 'low';
        let statusIcon = 'check-circle';
        let statusText = 'Normal';
        
        if (quantidade > 3000) {
            statusClass = 'high';
            statusIcon = 'exclamation-circle';
            statusText = 'Alto';
        } else if (quantidade > 1500) {
            statusClass = 'medium';
            statusIcon = 'exclamation-triangle';
            statusText = 'M√©dio';
        }
        
        totalGeral += quantidade;
        valorTotalGeral += valorTotalEsteira;
        
        html += `
            <tr>
                <td>${esteira.nome}</td>
                <td><strong>${quantidade.toLocaleString('pt-BR')}</strong></td>
                <td>R$ ${valorTotalEsteira.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                <td>R$ ${valorMedio.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                <td>${tempoMedio} ${tempoMedio === 1 ? 'dia' : 'dias'}</td>
                <td>
                    <span class="status-badge ${statusClass}">
                        <i class="fas fa-${statusIcon}"></i>
                        ${statusText}
                    </span>
                </td>
            </tr>
        `;
    });
    
    // Atualizar tabela
    elements.reportTableBody.innerHTML = html;
    
    // Atualizar resumo
    const valorMedioGeral = Math.floor(valorTotalGeral / totalGeral);
    elements.totalPropostas.textContent = totalGeral.toLocaleString('pt-BR');
    elements.valorTotal.textContent = 'R$ ' + valorTotalGeral.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    elements.valorMedio.textContent = 'R$ ' + valorMedioGeral.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    
    // Atualizar data/hora e quantidade de registros
    const agora = new Date();
    const dataHoraFormatada = agora.toLocaleDateString('pt-BR', { 
        day: '2-digit', 
        month: '2-digit', 
        year: 'numeric' 
    }) + ' √†s ' + agora.toLocaleTimeString('pt-BR', { 
        hour: '2-digit', 
        minute: '2-digit' 
    });
    
    elements.reportDateTime.textContent = dataHoraFormatada;
    elements.reportRowCount.textContent = esteiras.length;
}

// ==================== SQL MODAL ====================

function showSqlModal() {
    elements.sqlModal.style.display = 'flex';
    elements.loginOverlay.style.display = 'block';
}

function hideSqlModal() {
    elements.sqlModal.style.display = 'none';
    elements.loginOverlay.style.display = 'none';
}

function copySqlQuery() {
    const sqlText = elements.sqlCode.textContent;
    
    // Copiar para clipboard
    navigator.clipboard.writeText(sqlText).then(() => {
        showToast('Query SQL copiada com sucesso!', 'success');
    }).catch(err => {
        console.error('Erro ao copiar:', err);
        showToast('Erro ao copiar query', 'error');
    });
}

function showTableExplanation() {
    elements.tableExplainModal.style.display = 'flex';
    showToast('Exibindo estrutura das tabelas', 'info');
}

function hideTableExplanation() {
    elements.tableExplainModal.style.display = 'none';
}

// ==================== LOGOUT ====================

function logout() {
    currentUser = null;
    currentProfile = null;
    chatMessages = [];
    suggestionsAdded = false;
    lastUserQuestion = '';
    lastResponseType = 'text';
    
    hideChat();
    hideProfilePanel();
    hideLibrary();
    
    // Clear chat messages
    elements.chatMessages.innerHTML = `
        <div class="message bot-message">
            <div class="message-avatar">
                <i class="fas fa-robot"></i>
            </div>
            <div class="message-content">
                <div class="message-text">Ol√°! Como posso ajudar?</div>
                <div class="message-time">Agora</div>
            </div>
        </div>
    `;
    
    showToast('Sess√£o encerrada', 'info');
}

// ==================== TOAST ====================

function showToast(message, type = 'info') {
    elements.toast.textContent = message;
    elements.toast.className = `toast ${type} show`;
    
    setTimeout(() => {
        elements.toast.classList.remove('show');
    }, 3000);
}

// ==================== UTILITY FUNCTIONS ====================

function formatTime(date) {
    return date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
}

function formatDate(date) {
    return date.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short', year: 'numeric' });
}

function truncateText(text, maxLength) {
    if (text.length <= maxLength) return text;
    return text.substring(0, maxLength) + '...';
}

// ==================== INITIALIZATION ====================

console.log('‚úÖ Daycoval BackOffice - DATABRIDGE IA carregado!');
console.log('üìù Usu√°rios dispon√≠veis:');
console.log('   - admin@daycoval.com / admin123');
console.log('   - user@daycoval.com / user123');
console.log('   - dev@daycoval.com / dev123');

